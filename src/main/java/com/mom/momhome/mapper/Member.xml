<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Member">
	<select id="Member_isDuplicate" parameterType="MemberDto"
		resultType="Integer">
		select
		count(*) from User
		where user_id=#{ user_id }
	</select>

	<insert id="Member_insert" parameterType="MemberDto">
		INSERT INTO User(
		user_id
		, user_password
		, user_name
		, user_mail
		, user_phone
		, user_address1
		, user_address2
		, user_position
		, user_intro
		, user_delete
		) VALUES(
		#{
		user_id }
		, #{ user_password }
		, #{ user_name }
		, #{ user_mail }
		, #{ user_phone }
		, #{ user_address1 }
		, #{ user_address2 }
		, #{ user_position }
		, #{ user_intro }
		, 1
		)
	</insert>

	<select id="getPositionList" parameterType="BaseDto"
		resultType="BaseDto">
		select position from Code where CODEGROUP_ID='po'
	</select>

	<select id="Member_getInfo" parameterType="MemberDto"
		resultType="MemberDto">
		select * from user
		where user_id=#{ user_id } and USER_PASSWORD=#{ user_password } and user_delete=1
	</select>

	<update id="Member_update" parameterType="MemberDto">
		update User set
		user_name = #{ user_name }
		, user_mail = #{ user_mail }
		, user_phone = #{ user_phone }
		, user_address1 = #{ user_address1 }
		, user_address2 = #{ user_address2 }
		, user_position = #{ user_position }
		, user_intro = #{ user_intro }
		where user_id=#{ user_id }
	</update>

	<select id="Member_mercenaryList" parameterType="MercenaryDto"
		resultType="MercenaryDto">
		select * from (
		select
		A.mercenary_key
		,A.mercenary_title
		,A.user_key
		,A.game_key
		,A.mercenary_contents
		,mercenary_complete
		,reg_date
		,@rownum := @rownum+1 AS rnum
		from mercenary A, (select @rownum:=0) B
		<if test='key!=null and keyword!=null'>
			<if test='key=="1"'>
				where mercenary_title like concat('%',#{keyword}, '%')
			</if>
			<if test='key=="2"'>
				where mercenary_contents like concat('%',#{keyword}, '%')
			</if>
			<if test='key=="3"'>
				where mercenary_title like concat('%',#{keyword}, '%') or
				mercenary_contents like concat('%',#{keyword}, '%')
			</if>
		</if>
		order by mercenary_key desc
		) A where user_key=(
		select user_key from User
		where user_key=#{ user_key }
		) limit #{start}, #{pageSize}
	</select>

	<select id="Member_mercenaryGetTotal"
		parameterType="MercenaryDto" resultType="Integer">
		select count(*) from mercenary where user_key =(select user_key from
		User
		where user_key=#{ user_key })
		<if test='key!=null and keyword!=null'>
			<if test='key=="1"'>
				and mercenary_title like concat('%',#{keyword}, '%')
			</if>
			<if test='key=="2"'>
				and mercenary_contents like concat('%',#{keyword}, '%')
			</if>
			<if test='key=="3"'>
				and mercenary_title like concat('%',#{keyword}, '%') or
				mercenary_contents like concat('%',#{keyword}, '%')
			</if>
		</if>
	</select>
	
	<select id="Member_gameList" parameterType="GameDto"
		resultType="GameDto">
		select GAME_KEY
         ,(select TEAM_key from team B where B.TEAM_KEY =A.TEAM_KEY) as TEAM_key
         ,(select TEAM_NAME from team B where B.TEAM_KEY =A.TEAM_KEY) as TEAM_NAME
		 ,GAME_DATE
		 ,GAME_LOCATION
		 ,GAME_TITLE
		 ,GAME_CONTENTS
		 ,GAME_FDATE
		 ,rnum
		 from(select
 		A.GAME_KEY
 		,A.TEAM_KEY
 		,A.GAME_DATE
 		 ,A.GAME_LOCATION
		 ,A.GAME_TITLE
		 ,A.GAME_CONTENTS
		 ,A.GAME_FDATE
		,@rownum := @rownum+1 AS rnum
		from game A, (select @rownum:=0) B
		order by game_key desc
		) A where team_key=(
		select team_key from membership
		where user_key=#{user_key}) limit #{start}, #{pageSize}
	</select>

	<select id="Member_gameGetTotal"
		parameterType="GameDto" resultType="Integer">
		select count(*) from team  where team_key=(
		select team_key from membership
		where user_key=#{user_key})
		<if test='key!=null and keyword!=null'>
			<if test='key=="1"'>
				and game_title like concat('%',#{keyword}, '%')
			</if>
			<if test='key=="2"'>
				and game_contents like concat('%',#{keyword}, '%')
			</if>
			<if test='key=="3"'>
				and game_title like concat('%',#{keyword}, '%') or
				game_contents like concat('%',#{keyword}, '%')
			</if>
		</if>
	</select>
	
	<select id="Member_teamList" parameterType="TeamDto"
		resultType="TeamDto">
		select * from 
	       (select
	            A.team_name
	            ,A.team_key
	            ,A.team_fdate
	            ,A.team_fee
	            ,A.team_city 
	            ,A.team_intro
	            ,A.team_emblem
	            ,A.team_notice
	            ,A.team_num
	            ,A.team_recruit_yn
	            ,(select membership_role  from membership where team_key = 1 ) as membership_role
	             ,@rownum := @rownum+1 AS rnum
	            from team A, (select @rownum:=0) B
	            order by team_key desc
		) A where team_key=(	select team_key from membership where user_key=#{user_key}) limit #{start}, #{pageSize}
	</select>

	<select id="Member_teamGetTotal"
		parameterType="TeamDto" resultType="Integer">
		select count(*) from game  where team_key=(
		select team_key from membership
		where user_key=#{user_key})
		<if test='key!=null and keyword!=null'>
			<if test='key=="1"'>
				and game_title like concat('%',#{keyword}, '%')
			</if>
			<if test='key=="2"'>
				and game_contents like concat('%',#{keyword}, '%')
			</if>
			<if test='key=="3"'>
				and game_title like concat('%',#{keyword}, '%') or
				game_contents like concat('%',#{keyword}, '%')
			</if>
		</if>
	</select>

	<select id="Member_findid" parameterType="MemberDto"
		resultType="MemberDto">
		select
		user_id
		from User
		where user_name=#{user_name} and user_phone=#{user_phone}
	</select>

	<select id="Member_findpassword" parameterType="MemberDto"
		resultType="MemberDto">
		select
		user_password
		from User
		where user_id=#{user_id} and user_name=#{user_name} and
		user_phone=#{user_phone}
	</select>

	<update id="Member_delete" parameterType="MemberDto">
		update user set
		user_delete=2 where user_key=#{ user_key }
	</update>
</mapper>